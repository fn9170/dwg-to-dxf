<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>天津地铁5号线数据查看器</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 350px;
            background: white;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        .sidebar-header {
            padding: 20px;
            background: #2c3e50;
            color: white;
            text-align: center;
        }

        .sidebar-header h1 {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: 12px;
            opacity: 0.8;
        }

        .file-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .file-item {
            padding: 8px 12px;
            margin: 2px 0;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
        }

        .file-item:hover {
            background: #e9ecef;
            border-color: #007bff;
        }

        .file-item.active {
            background: #007bff;
            color: white;
            border-color: #0056b3;
        }

        .file-item .file-name {
            font-weight: bold;
            margin-bottom: 2px;
        }

        .file-item .file-info {
            font-size: 11px;
            opacity: 0.7;
        }

        .controls {
            padding: 15px;
            border-top: 1px solid #ddd;
            background: #f8f9fa;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 12px;
            color: #495057;
        }

        .control-group select,
        .control-group input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 12px;
        }

        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #0056b3;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-group {
            display: flex;
            gap: 8px;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px;
            border-radius: 8px;
            z-index: 1000;
        }

        .stats {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }

        .legend-color {
            width: 20px;
            height: 3px;
            margin-right: 8px;
            border-radius: 2px;
        }

        .search-box {
            margin-bottom: 15px;
        }

        .search-box input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 12px;
        }

        .layer-toggle {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }

        .layer-toggle input[type="checkbox"] {
            margin-right: 8px;
        }

        .layer-toggle label {
            margin: 0;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>天津地铁5号线数据查看器</h1>
                <p>DXF数据可视化界面</p>
            </div>
            
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="搜索文件..." />
            </div>

            <div class="file-list" id="fileList">
                <!-- 文件列表将在这里动态生成 -->
            </div>

            <div class="controls">
                <div class="control-group">
                    <label>图层控制</label>
                    <div id="layerControls">
                        <!-- 图层控制将在这里动态生成 -->
                    </div>
                </div>

                <div class="control-group">
                    <label>显示选项</label>
                    <div class="btn-group">
                        <button class="btn" onclick="showAllLayers()">显示全部</button>
                        <button class="btn btn-secondary" onclick="hideAllLayers()">隐藏全部</button>
                    </div>
                </div>

                <div class="control-group">
                    <label>地图操作</label>
                    <div class="btn-group">
                        <button class="btn" onclick="fitToBounds()">适应视图</button>
                        <button class="btn btn-secondary" onclick="clearMap()">清空地图</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
            <div class="stats" id="stats">
                加载中...
            </div>
            <div class="legend" id="legend">
                <strong>图例</strong>
                <div class="legend-item">
                    <div class="legend-color" style="background: #007bff;"></div>
                    <span>线要素</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #28a745;"></div>
                    <span>面要素</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let map;
        let layers = {};
        let currentData = [];
        let allFeatures = [];
        let layerGroups = {};

        const DATA_DIR = 'tj_metro_lines/';

        // 将summary里的绝对路径/系统路径转换为相对路径
        function toRelativePath(p) {
            if (!p) return '';
            // 统一分隔符
            const unified = String(p).replace(/\\\\/g, '/');
            const marker = DATA_DIR;
            const idx = unified.lastIndexOf(marker);
            if (idx !== -1) {
                return marker + unified.slice(idx + marker.length);
            }
            // 如果没有包含目录名，取文件名后拼接
            const base = unified.split('/').pop();
            return marker + base;
        }

        // 初始化地图
        function initMap() {
            map = L.map('map').setView([39.0842, 117.2009], 12); // 天津市中心坐标
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '© Esri'
            });
            const baseMaps = {
                "街道地图": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
                "卫星影像": satelliteLayer
            };
            L.control.layers(baseMaps).addTo(map);
        }

        // 加载文件列表
        async function loadFileList() {
            try {
                const response = await fetch(DATA_DIR + 'summary.geojson');
                if (!response.ok) throw new Error('HTTP ' + response.status);
                const data = await response.json();
                if (data.properties && data.properties.summary) {
                    const summary = data.properties.summary;
                    // 转换为相对路径
                    const files = (summary.individual_files || []).map(toRelativePath);
                    displayFileList(files);
                    updateStats(summary);
                }
            } catch (error) {
                console.error('加载文件列表失败:', error);
                document.getElementById('fileList').innerHTML = '<p style="padding: 20px; color: red;">加载失败，请检查文件路径</p>';
            }
        }

        // 显示文件列表
        function displayFileList(files) {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            files.forEach((file) => {
                const rel = toRelativePath(file);
                const rawName = rel.split('/').pop().replace('.geojson', '');
                const fileName = decodeURIComponent(rawName);
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.onclick = () => loadFile(rel, fileName);
                fileItem.innerHTML = `
                    <div class="file-name">${fileName}</div>
                    <div class="file-info">点击加载到地图</div>
                `;
                fileList.appendChild(fileItem);
            });
        }

        // 更新统计信息
        function updateStats(summary) {
            const stats = document.getElementById('stats');
            stats.innerHTML = `
                <strong>数据统计</strong><br>
                总要素: ${summary.total_features}<br>
                线要素: ${summary.lines}<br>
                面要素: ${summary.areas}<br>
                图层数: ${summary.layers.length}
            `;
        }

        // 加载单个文件
        async function loadFile(filePath, fileName) {
            try {
                const url = encodeURI(filePath);
                const response = await fetch(url);
                if (!response.ok) throw new Error('HTTP ' + response.status + ' - ' + url);
                const data = await response.json();
                if (data.type === 'Feature') {
                    addFeatureToMap(data, fileName);
                } else if (data.type === 'FeatureCollection' && data.features?.length) {
                    // 兼容可能的集合文件
                    data.features.forEach((f, idx) => addFeatureToMap(f, `${fileName}_${idx+1}`));
                } else {
                    throw new Error('无效的GeoJSON');
                }
            } catch (error) {
                console.error('加载文件失败:', error);
                alert('加载文件失败: ' + error.message);
            }
        }

        // 添加要素到地图
        function addFeatureToMap(feature, fileName) {
            if (layers[fileName]) {
                map.removeLayer(layers[fileName]);
            }
            let layer;
            const properties = feature.properties || {};
            const layerName = properties.layer || '未知图层';
            if (feature.geometry.type === 'LineString') {
                const coordinates = feature.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                layer = L.polyline(coordinates, {
                    color: getColorByLayer(layerName),
                    weight: 3,
                    opacity: 0.8
                });
            } else if (feature.geometry.type === 'Polygon') {
                const coordinates = feature.geometry.coordinates.map(ring => ring.map(coord => [coord[1], coord[0]]));
                layer = L.polygon(coordinates, {
                    color: getColorByLayer(layerName),
                    fillColor: getColorByLayer(layerName),
                    fillOpacity: 0.3,
                    weight: 2
                });
            }
            if (layer) {
                layer.bindPopup(`
                    <strong>${fileName}</strong><br>
                    类型: ${feature.geometry.type}<br>
                    图层: ${layerName}<br>
                    实体类型: ${properties.type || '未知'}
                `);
                layer.addTo(map);
                layers[fileName] = layer;
                updateLayerControls();
            }
        }

        function getColorByLayer(layerName) {
            const colors = ['#007bff','#28a745','#dc3545','#ffc107','#17a2b8','#6f42c1','#fd7e14','#e83e8c','#20c997','#6c757d'];
            let hash = 0;
            for (let i = 0; i < layerName.length; i++) hash = layerName.charCodeAt(i) + ((hash << 5) - hash);
            return colors[Math.abs(hash) % colors.length];
        }

        function updateLayerControls() {
            const layerControls = document.getElementById('layerControls');
            layerControls.innerHTML = '';
            Object.keys(layers).forEach(fileName => {
                const layer = layers[fileName];
                const div = document.createElement('div');
                div.className = 'layer-toggle';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = true;
                checkbox.onchange = (e) => {
                    if (e.target.checked) layer.addTo(map); else map.removeLayer(layer);
                };
                const label = document.createElement('label');
                label.textContent = fileName;
                div.appendChild(checkbox);
                div.appendChild(label);
                layerControls.appendChild(div);
            });
        }

        // 搜索功能
        document.addEventListener('DOMContentLoaded', function() {
            const input = document.getElementById('searchInput');
            input.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                document.querySelectorAll('.file-item').forEach(item => {
                    const fileName = item.querySelector('.file-name').textContent.toLowerCase();
                    item.style.display = fileName.includes(searchTerm) ? 'block' : 'none';
                });
            });
        });

        function showAllLayers() {
            Object.values(layers).forEach(layer => { if (!map.hasLayer(layer)) layer.addTo(map); });
            document.querySelectorAll('#layerControls input[type="checkbox"]').forEach(cb => cb.checked = true);
        }

        function hideAllLayers() {
            Object.values(layers).forEach(layer => map.removeLayer(layer));
            document.querySelectorAll('#layerControls input[type="checkbox"]').forEach(cb => cb.checked = false);
        }

        function fitToBounds() {
            const visibleLayers = Object.values(layers).filter(layer => map.hasLayer(layer));
            if (visibleLayers.length > 0) {
                const group = L.featureGroup(visibleLayers);
                map.fitBounds(group.getBounds());
            }
        }

        function clearMap() {
            Object.values(layers).forEach(layer => map.removeLayer(layer));
            layers = {};
            updateLayerControls();
        }

        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            loadFileList();
        });
    </script>
</body>
</html>
